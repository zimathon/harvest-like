# Firestore基本知識とインデックスの役割

## 📚 Firestoreとは？

Google Cloud Firestore は、NoSQLドキュメント指向データベースです。MongoDBと似ていますが、Googleが提供するフルマネージドサービスです。

### 主な特徴
- **リアルタイム同期**: データの変更を即座にクライアントに反映
- **オフライン対応**: ネットワーク切断時もローカルキャッシュで動作継続
- **自動スケーリング**: トラフィックに応じて自動的にスケール
- **強力なセキュリティ**: セキュリティルールで細かいアクセス制御が可能

## 🗂️ データ構造

Firestoreは階層的なデータ構造を持ちます：

```
Firestore Database
├── コレクション (Collection) = テーブルのようなもの
│   ├── ドキュメント (Document) = レコード/行のようなもの
│   │   ├── フィールド (Field) = カラム/属性
│   │   └── サブコレクション (Subcollection) = ネストされたコレクション
```

### 例：Harvest-likeアプリのデータ構造

```
firestore
├── users (コレクション)
│   ├── user1 (ドキュメントID)
│   │   ├── name: "Admin User"
│   │   ├── email: "admin@example.com"
│   │   └── role: "admin"
│   └── user2
│       ├── name: "John Doe"
│       ├── email: "john@example.com"
│       └── role: "member"
│
├── projects (コレクション)
│   ├── project1
│   │   ├── name: "Website Redesign"
│   │   ├── client: "ABC Company"
│   │   ├── userId: "user1"
│   │   └── createdAt: Timestamp
│   └── project2
│       ├── name: "Mobile App"
│       ├── client: "XYZ Corp"
│       ├── userId: "user2"
│       └── createdAt: Timestamp
│
└── timeEntries (コレクション)
    ├── entry1
    │   ├── userId: "user1"
    │   ├── projectId: "project1"
    │   ├── date: "2025-08-11"
    │   └── hours: 8
    └── entry2
        ├── userId: "user2"
        ├── projectId: "project2"
        ├── date: "2025-08-11"
        └── hours: 6
```

## 🔍 クエリとインデックスの必要性

### 基本的なクエリ

Firestoreでデータを取得する際、様々な条件でフィルタリングできます：

```javascript
// 単純なクエリ（インデックス不要）
db.collection('projects')
  .where('userId', '==', 'user1')
  .get()

// 複合クエリ（インデックスが必要！）
db.collection('projects')
  .where('userId', '==', 'user1')
  .orderBy('createdAt', 'desc')
  .get()
```

## 📊 インデックスとは？

**インデックス = データベースの「目次」**

本の目次が特定のトピックを素早く見つけるのに役立つように、インデックスはデータベースが特定のデータを高速に検索するための仕組みです。

### なぜインデックスが必要？

1. **パフォーマンス向上**
   - インデックスなし：全データをスキャン（遅い）
   - インデックスあり：必要なデータに直接アクセス（速い）

2. **複雑なクエリの実行**
   - 複数条件での検索
   - ソート（並び替え）を含むクエリ
   - 範囲検索

### 具体例：プロジェクト一覧の取得

```javascript
// このクエリにはインデックスが必要
db.collection('projects')
  .where('userId', '==', 'currentUserId')  // 条件1: 特定ユーザーのプロジェクト
  .orderBy('createdAt', 'desc')            // 条件2: 作成日時で降順ソート
  .get()
```

このクエリを効率的に実行するには、`userId`と`createdAt`の複合インデックスが必要です。

## 🏗️ インデックスの種類

### 1. 単一フィールドインデックス（自動作成）
```javascript
// これらは自動的にインデックスが作成される
.where('userId', '==', 'user1')
.orderBy('name')
```

### 2. 複合インデックス（手動作成が必要）
```javascript
// 複数フィールドの組み合わせは手動でインデックス作成が必要
.where('userId', '==', 'user1')
.where('status', '==', 'active')
.orderBy('createdAt')
```

## ⚙️ インデックス作成の流れ

1. **エラー発生**
   ```
   Error: 9 FAILED_PRECONDITION: The query requires an index
   ```

2. **エラーメッセージ内のURLをクリック**
   Firestoreが自動的に必要なインデックスを判断し、作成用URLを提供

3. **Firebase Consoleで確認・作成**
   - URLをクリック
   - インデックス設定を確認
   - 「作成」ボタンをクリック

4. **作成完了を待つ**
   - 通常5-10分で作成完了
   - ステータスが「Building」→「Enabled」に変わる

## 📈 Harvest-likeアプリで必要なインデックス

### プロジェクト一覧
```
コレクション: projects
フィールド1: userId (昇順)
フィールド2: createdAt (降順)
用途: ユーザーごとのプロジェクトを新しい順に表示
```

### タイムエントリー
```
コレクション: timeEntries
フィールド1: userId (昇順)
フィールド2: date (降順)
用途: ユーザーごとの作業時間を日付順に表示
```

### 請求書
```
コレクション: invoices
フィールド1: clientId (昇順)
フィールド2: createdAt (降順)
用途: クライアントごとの請求書を新しい順に表示
```

## 💰 コストへの影響

### インデックスのコスト
- **作成**: 無料
- **保存**: 最初の20GBまで無料（通常のアプリでは十分）
- **読み取り**: インデックスを使うことで読み取り回数が削減され、むしろコスト削減

### 無料枠での運用
- ドキュメント読み取り: 50,000回/日
- ドキュメント書き込み: 20,000回/日
- インデックス保存: 20GB
- **結論**: 小規模〜中規模アプリなら無料枠で十分運用可能

## 🎯 ベストプラクティス

1. **必要なインデックスのみ作成**
   - 使用するクエリパターンに応じて作成
   - 不要なインデックスは削除してストレージを節約

2. **複合インデックスの順序に注意**
   - 等価条件（==）のフィールドを先に
   - 範囲条件（<, >, <=, >=）やorderByのフィールドを後に

3. **開発時にインデックスを確認**
   - ローカル開発環境でクエリをテスト
   - 本番環境デプロイ前にインデックスを作成

4. **監視とメンテナンス**
   - Firebase Consoleで使用状況を定期的に確認
   - 未使用のインデックスは削除

## 🔧 トラブルシューティング

### よくあるエラーと対処法

1. **"The query requires an index"**
   - 原因: 複合クエリに必要なインデックスがない
   - 対処: エラーメッセージのURLからインデックスを作成

2. **"Too many index entries"**
   - 原因: 配列フィールドに対する複雑なインデックス
   - 対処: クエリ設計を見直し、配列の使用を最小限に

3. **クエリが遅い**
   - 原因: インデックスが適切に設定されていない
   - 対処: Firebase ConsoleでQuery Explainを使用して分析

## 📝 まとめ

Firestoreのインデックスは、データベースのパフォーマンスを最適化する重要な仕組みです。適切なインデックスを作成することで：

- ✅ クエリが高速化
- ✅ アプリのレスポンスが向上
- ✅ 読み取りコストが削減
- ✅ ユーザー体験が改善

Harvest-likeアプリでは、ユーザーごとのデータを効率的に取得するため、複数のインデックスが必要です。エラーが発生したら、提供されるURLから簡単にインデックスを作成できます。

---

*作成日: 2025年8月11日*
*作成者: Claude Code*